# About
This package allows you to run object detection models on the machine running ROS. This is intended as an alternative to the OAK cameras while doing simulations, but can also be potentially used on the Jetson itself. 

# Usage
The package supports TensorFlow 1 GraphDef models such as MobileNetV2 and PyTorch Hub models such as YOLOv5. Each approach has a more detailed guide below ([TF1 GraphDef](#tensorflow-1-mobilenetv2), [PyTorch Hub](#pytorch-yolov5)).

The [faux_detector.launch](launch/faux_detector.launch) file is the main launch file of the package. These are parameters common to both approaches:

- `image_topic`: topic of the image topic that the dectector takes as input.
- `detection_topic`: topic of the detection result, has type **vision_msgs/Detection2DArray**.
- `min_score_thresh`: minimum confidence to accept detection, in range [0, 1].
- `label_file`: label file to match class number and class name. This is, at the moment, in the style of the `.pbtxt` files generated by TF1 GraphDef models.
- `model_type`: can either be `"graphdef"` for TF1 GraphDef or `"torchhub"` for PyTorch Hub.

For TF1 GraphDef models:
- `model_file`: path to the `.pb` file of the model.

For PyTorch Hub models:
- `model_path`: path to the model folder, such as the YOLOv5 repository [ultralytics/yolov5](https://github.com/ultralytics/yolov5]). Does not need to be changed if you're using YOLOv5 since it is a submodule.
- `weights_file`: path to the `.pt` file of the trained model that contains the weights.
- `subprocess_file`: path to the subprocess file, and does not need to be changed (more details in the [PyTorch Hub](#pytorch-yolov5) section.)
- `subprocess_python_file`: path to the Python 3 executable (more details in the [PyTorch Hub](#pytorch-yolov5) section.)

## Tensorflow 1 (MobileNetV2)
This approach keeps a Tensorflow 1 session open while running inference on each new image, which achieves real-time speeds like a deployed model. You can visit [graphdef.py](scripts/graphdef.py) to learn more.

### Install `object_detection`
The package uses the `object_detection` package provided in [TensorFlow's repository](https://github.com/tensorflow/models/tree/master/research/object_detection). To install:
- Please clone the branch `r1.13.0`
- `cd` into `research`
- Do the following (courtesy of [rakidedigama](https://stackoverflow.com/a/57002353)):
```
python setup.py build
python setup.py install
```

### Install other dependencies
The following installs the rest of the dependencies. Note that this installs a non-GPU version of tensorflow. If you want to use GPU, install tensorflow-gpu instead.
```
pip2 install --user tensorflow==1.15.0 Cython contextlib2 pillow lxml
```

If there is an issue with CUDA, possibly your graphics card is being used for display and cannot run TensorFlow (see [this](https://stackoverflow.com/questions/41965187/nvidia-device-error-in-tensorflow) and [this](https://stackoverflow.com/a/39661999)). Remove availability of CUDA devices could help (only show available devices not used for display):
```
export CUDA_VISIBLE_DEVICES=1
```

### Install protobuf
If you are on linux:

Download and install the 3.0 release of protoc, then unzip the file.
```
# From tensorflow/models/research/(be in this directory)
wget -O protobuf.zip https://github.com/google/protobuf/releases/download/v3.0.0/protoc-3.0.0-linux-x86_64.zip
unzip protobuf.zip
rm -rf protobuf.zip
```

Run the compilation process again, but use the downloaded version of protoc

From tensorflow/models/research/
```
./bin/protoc object_detection/protos/*.proto --python_out=.
```

## PyTorch Hub (Yolov5)
This approach uses the PyTorch Hub to open a model and run inferences, but there's a tricky issue that PyTorch no longer supports Python 2.7. Instead, this uses the `subprocess` package to run a Python 3 subprocess with PyTorch installed. Back-and-forth communication is facilitated with `subprocess.PIPE`s. You can visit [torchhub.py](scripts/torchhub.py) to learn more.

At the moment, it also relies on the `object_detection` package described in the above section ([Install `object_detection`](#install-objectdetection)). Please go there and install accordingly.

### Launch parameters
The `subprocess_file` parameter in the launch file does not need to be changed, as the default path points to the correctly-working [faux_subprocess.py](scripts/faux_subprocess.py).

The `subprocess_python_file` parameter, however, needs to be modified to point to a Python 3 executable that has PyTorch installed. The next section discusses how you can do this.

### Install PyTorch
If you're in a Python 2 environment, it is best to use virtual environment managers such as [Miniconda](https://docs.conda.io/en/latest/miniconda.html) to create a new environment with Python 3 and proper packages.

In your Python 3 environment, refer to PyTorch's [Start Locally](https://pytorch.org/get-started/locally/) guide to find out what to install for your machine. If you have an unlisted version of CUDA, the following might help (using pip):

```
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu<CUDA VERSION NUMBER>
```

where `<CUDA VERSION NUMBER>` is your CUDA version without a dot, e.g. 116, 117 or 118. If this does not work, you can try PyTorch's [Previous Versions](https://pytorch.org/get-started/previous-versions/).

### Get Python executable path
Using your new Python 3, run the following:
```
import sys
print(sys.executable)
```
Or, from the terminal:
```
python -c "import sys; print(sys.executable)"
```
This will give you the full path to the Python executable that you can put in the `subprocess_python_file` parameter.
